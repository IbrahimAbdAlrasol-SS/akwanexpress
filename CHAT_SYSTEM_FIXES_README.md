# ุฅุตูุงุญุงุช ูุธุงู ุงูุฏุฑุฏุดุฉ

## ๐ง ุงููุดุงูู ุงูุชู ุชู ุฅุตูุงุญูุง

### 1. **ูุดููุฉ ุนุฑุถ ุฑุณุงุฆู ุงูุชุฐุงูุฑ ุงูุณุงุจูุฉ**
**ุงููุดููุฉ:** ุนูุฏ ูุชุญ ุชุฐูุฑุฉ ุฌุฏูุฏุฉุ ูุงูุช ุชุธูุฑ ุฑุณุงุฆู ูู ุงูุชุฐุงูุฑ ุงูุณุงุจูุฉ.

**ุงูุญู ุงููุทุจู:**
- ุฅุถุงูุฉ ูุชุชุจุน ููุชุฐูุฑุฉ ุงูุญุงููุฉ (`_currentTicketId`) ูู `ChatMessagesNotifier`
- ุชุตููุฉ ุฌููุน ุงูุฑุณุงุฆู ุญุณุจ `ticketId` ูู ุฌููุน ุงูุนูููุงุช
- ูุณุญ ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ุชููุงุฆูุงู ุนูุฏ ุชุบููุฑ ุงูุชุฐูุฑุฉ
- ุฅุถุงูุฉ ุงูุชุญูู ูู `ticketId` ูู ูุนุงูุฌุงุช SignalR

### 2. **ุชุญุณูู ูุนุงูุฌุฉ ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ**
**ุงููุดููุฉ:** ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ ูู ุชูู ุชูุตูู ุญุณุจ ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ.

**ุงูุญู ุงููุทุจู:**
- ุชุญุฏูุซ `addReceivedMessage()` ูุชุฌุงูู ุงูุฑุณุงุฆู ุบูุฑ ุงููุชุนููุฉ ุจุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
- ุฅุถุงูุฉ ุชุณุฌูู ููุตู ูุชุชุจุน ุงูุฑุณุงุฆู ุงููุฑููุถุฉ
- ุงูุชุญูู ูู ูุฌูุฏ `ticketId` ูู ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ

## ๐ ุงููููุงุช ุงููุญุฏุซุฉ

### 1. `chat_provider.dart`
```dart
// ุฅุถุงูุงุช ุฌุฏูุฏุฉ:
String? _currentTicketId; // ูุชุชุจุน ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ

void setCurrentTicket(String ticketId) // ุชุนููู ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
bool _isMessageForCurrentTicket(ChatMessage message) // ุงูุชุญูู ูู ุงูุชุฐูุฑุฉ
List<ChatMessage> getMessagesForTicket(String ticketId) // ุงูุญุตูู ุนูู ุฑุณุงุฆู ุชุฐูุฑุฉ ูุญุฏุฏุฉ
String? get currentTicketId // ุงูุญุตูู ุนูู ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
```

**ุงูุชุญุณููุงุช:**
- ุชุตููุฉ ุงูุฑุณุงุฆู ูู `setMessages()`, `addMessages()`, `addReceivedMessage()`
- ูุณุญ ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ุนูุฏ ุชุบููุฑ ุงูุชุฐูุฑุฉ
- ุชุณุฌูู ููุตู ููุนูููุงุช

### 2. `chat_screen.dart`
```dart
// ูู _initializeChat():
final notifier = ref.read(chatMessagesProvider.notifier);
notifier.setCurrentTicket(widget.ticketId); // ุชุนููู ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ

// ูู dispose():
notifier.setCurrentTicket(''); // ูุณุญ ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
```

**ุงูุชุญุณููุงุช:**
- ุชุนููู ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ ุนูุฏ ูุชุญ ุงูุดุงุดุฉ
- ูุณุญ ุงูุชุฐูุฑุฉ ุนูุฏ ุฅุบูุงู ุงูุดุงุดุฉ
- ุถูุงู ุนุฒู ุงูุฑุณุงุฆู ุจูู ุงูุชุฐุงูุฑ

### 3. `chat_hub_connection.dart`
```dart
// ูู ูุนุงูุฌ ReceiveMessage:
if (newMessage.ticketId == null || newMessage.ticketId!.isEmpty) {
  print('โ๏ธ Message ignored - no ticketId provided');
  return;
}

// ูู ูุนุงูุฌ LoadChatHistory:
final ticketIds = messages.map((m) => m.ticketId).toSet();
print('๐ซ Messages contain tickets: $ticketIds');
```

**ุงูุชุญุณููุงุช:**
- ุงูุชุญูู ูู ูุฌูุฏ `ticketId` ูู ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ
- ุชุณุฌูู ูุนูููุงุช ุงูุชุฐุงูุฑ ูู ุชุงุฑูุฎ ุงูุฏุฑุฏุดุฉ
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

## ๐ ููููุฉ ุนูู ุงููุธุงู ุงููุญุฏุซ

### 1. **ุนูุฏ ูุชุญ ุชุฐูุฑุฉ ุฌุฏูุฏุฉ:**
```
1. ุชุนููู ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ โ setCurrentTicket(ticketId)
2. ูุณุญ ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ โ clearMessages()
3. ุทูุจ ุชุงุฑูุฎ ุงูุฏุฑุฏุดุฉ โ requestChatHistory(ticketId)
4. ุชุตููุฉ ุงูุฑุณุงุฆู ุงููุงุฑุฏุฉ โ ููุท ุฑุณุงุฆู ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
```

### 2. **ุนูุฏ ุงุณุชูุจุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ:**
```
1. ุงูุชุญูู ูู ูุฌูุฏ ticketId
2. ููุงุฑูุฉ ticketId ูุน ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
3. ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ููุท ุฅุฐุง ูุงูุช ููุชุฐูุฑุฉ ุงูุญุงููุฉ
4. ุชุฌุงูู ุงูุฑุณุงุฆู ุงูุฃุฎุฑู ูุน ุชุณุฌูู ุงูุณุจุจ
```

### 3. **ุนูุฏ ุชุญููู ุชุงุฑูุฎ ุงูุฏุฑุฏุดุฉ:**
```
1. ุงุณุชูุจุงู ุฌููุน ุงูุฑุณุงุฆู ูู ุงูุฎุงุฏู
2. ุชุตููุฉ ุงูุฑุณุงุฆู ุญุณุจ ุงูุชุฐูุฑุฉ ุงูุญุงููุฉ
3. ุนุฑุถ ุงูุฑุณุงุฆู ุงููุตูุงุฉ ููุท
4. ุชุณุฌูู ุนุฏุฏ ุงูุฑุณุงุฆู ุงููุตูุงุฉ
```

## ๐งช ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช

### ุงุฎุชุจุงุฑ ุนุฒู ุงูุฑุณุงุฆู:
1. ูุชุญ ุชุฐูุฑุฉ A ููุดุงูุฏุฉ ุฑุณุงุฆููุง
2. ูุชุญ ุชุฐูุฑุฉ B - ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงุฆู B ููุท
3. ุงูุนูุฏุฉ ูุชุฐูุฑุฉ A - ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงุฆู A ููุท

### ุงุฎุชุจุงุฑ ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ:
1. ูุชุญ ุชุฐูุฑุฉ A
2. ุฅุฑุณุงู ุฑุณุงูุฉ ูู ุงูุฏุงุดุจูุฑุฏ ูุชุฐูุฑุฉ B
3. ุงูุชุฃูุฏ ูู ุนุฏู ุธููุฑ ุงูุฑุณุงูุฉ ูู ุชุฐูุฑุฉ A
4. ูุชุญ ุชุฐูุฑุฉ B ูุงูุชุฃูุฏ ูู ุธููุฑ ุงูุฑุณุงูุฉ

## ๐ ุชุณุฌูู ุงููุธุงู

ุงููุธุงู ุงูุขู ูุณุฌู:
- ุชุบููุฑ ุงูุชุฐุงูุฑ: `๐ Switching to ticket: X (from: Y)`
- ุชุตููุฉ ุงูุฑุณุงุฆู: `๐ Set X messages (filtered from Y)`
- ุฑูุถ ุงูุฑุณุงุฆู: `โ๏ธ Message ignored - not for current ticket`
- ูุนูููุงุช ุงูุชุฐุงูุฑ: `๐ซ Messages contain tickets: [...]`

## ๐ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

1. **ุนุฒู ูุงูู ููุฑุณุงุฆู** ุจูู ุงูุชุฐุงูุฑ ุงููุฎุชููุฉ
2. **ูุณุญ ุชููุงุฆู** ููุฑุณุงุฆู ุงูุณุงุจูุฉ ุนูุฏ ุชุบููุฑ ุงูุชุฐูุฑุฉ
3. **ุชุตููุฉ ุฐููุฉ** ููุฑุณุงุฆู ุงููุงุฑุฏุฉ
4. **ุชุณุฌูู ููุตู** ูุชุชุจุน ุงูุนูููุงุช
5. **ูุนุงูุฌุฉ ูุญุณูุฉ** ููุฃุฎุทุงุก

## ๐ฎ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

1. **ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช** ููุฑุณุงุฆู ุงููุญููุฉ ูุณุจูุงู
2. **ุชุญููู ุชุฏุฑูุฌู** ููุฑุณุงุฆู ุงููุฏููุฉ
3. **ุฅุดุนุงุฑุงุช ุฐููุฉ** ุญุณุจ ุงูุชุฐูุฑุฉ ุงููุดุทุฉ
4. **ุฏุนู ุงูุชุฐุงูุฑ ุงููุชุนุฏุฏุฉ** ูู ููุณ ุงูููุช

## ๐๏ธ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ูู ุชุธูุฑ ุงูุฑุณุงุฆู:
1. ุชุญูู ูู logs: `๐ฏ Current Ticket ID`
2. ุชุญูู ูู ุชุตููุฉ ุงูุฑุณุงุฆู: `๐ Set X messages (filtered from Y)`
3. ุชุญูู ูู ุงุชุตุงู SignalR: `โ SignalR connection established`

### ุฅุฐุง ุธูุฑุช ุฑุณุงุฆู ุฎุงุทุฆุฉ:
1. ุชุญูู ูู ุชุนููู ุงูุชุฐูุฑุฉ: `๐ Switching to ticket`
2. ุชุญูู ูู ุฑูุถ ุงูุฑุณุงุฆู: `โ๏ธ Message ignored`
3. ุชุญูู ูู ูุนุฑู ุงูุชุฐูุฑุฉ ูู ุงูุฑุณุงุฆู: `๐ซ Ticket ID`